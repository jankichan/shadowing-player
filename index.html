<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å½±å­æ’­æ”¾å™¨ V11.1 (å½•éŸ³å¯¼èˆªç‰ˆ)</title>
    <style>
        /* === å…¨å±€åŸºç¡€ === */
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f8f9fa; --active-bg: #e3f2fd; --highlight: #f1c40f; --record: #e74c3c; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; display: flex; flex-direction: column; background: var(--bg); }
        body, #transcript-list, .line-content, .vocab-item { -webkit-user-select: text !important; user-select: text !important; }
        .line-time, button, .tab, header { -webkit-user-select: none !important; user-select: none !important; }

        /* === é¡¶éƒ¨ === */
        header { padding: 8px; background: #fff; border-bottom: 1px solid #ddd; display: flex; overflow-x: auto; gap: 8px; align-items: center; white-space: nowrap; flex-shrink: 0; -webkit-overflow-scrolling: touch; }
        .group { display: flex; align-items: center; gap: 4px; background: #f1f3f5; padding: 4px 8px; border-radius: 6px; border: 1px solid #e9ecef; }
        input[type="text"] { border: 1px solid #ccc; width: 80px; font-size: 12px; padding: 4px; }
        input[type="file"] { width: 140px; font-size: 11px; }
        
        /* === ä¸»ä½“ === */
        main { display: flex; flex-direction: column; flex: 1; overflow: hidden; width: 100%; }
        
        /* è§†é¢‘åŒº */
        #video-section { flex: none; height: 35vh; width: 100%; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #play-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; z-index: 5; cursor: pointer; display: none; }
        .big-play-btn { font-size: 50px; color: white; opacity: 0.8; }
        #video-status { position: absolute; color: #fff; font-size: 14px; background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 4px; pointer-events: none; display: none; z-index: 10; }
        #video-overlay { position: absolute; bottom: 10px; width: 95%; text-align: center; pointer-events: none; display: none; text-shadow: 0 1px 3px rgba(0,0,0,0.9); z-index: 2; }
        .overlay-source { color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 2px; line-height: 1.2; }
        .overlay-target { color: #ffd700; font-size: 13px; }
        .vocab-highlight { color: #ffeb3b !important; text-decoration: underline; }
        #overlay-toggle { position: absolute; top: 10px; right: 10px; z-index: 20; }
        .toggle-btn { background: rgba(0,0,0,0.5); color: #fff; border: 1px solid rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 15px; font-size: 12px; }
        .toggle-btn.active { background: var(--accent); border-color: var(--accent); }

        /* é¢æ¿åŒº */
        #right-panel { flex: 1; background: #fff; border-top: 1px solid #ccc; display: flex; flex-direction: column; min-height: 0; position: relative; }
        
        .tabs { display: flex; border-bottom: 1px solid #ddd; background: #f8f9fa; flex-shrink: 0; height: 40px; }
        .tab { flex: 1; line-height: 40px; text-align: center; font-size: 14px; color: #666; font-weight: 500; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); background: #fff; color: var(--accent); }
        
        .panel-content { flex: 1; overflow: hidden; display: none; flex-direction: column; height: 100%; }
        .panel-content.active { display: flex; }

        /* æ§åˆ¶æ  */
        #controls-bar { padding: 6px; background: #fff; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
        .ctrl-row { display: flex; gap: 6px; }
        button.act-btn { flex: 1; padding: 8px 0; border: 1px solid #ced4da; background: #fff; border-radius: 4px; font-size: 13px; touch-action: manipulation; display: flex; align-items: center; justify-content: center; }
        button.act-btn:active { background: #e9ecef; }
        button.act-btn.active { background: #e3f2fd; color: var(--accent); border-color: var(--accent); }
        button.act-btn.loop-on { background: #ff9800; color: white; border-color: #f57c00; }
        select { flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; background: white; }

        #transcript-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 60px; }
        .line { padding: 12px 10px; border-bottom: 1px solid #f1f1f1; display: flex; gap: 8px; }
        .line.active { background: var(--active-bg); border-left: 4px solid var(--accent); }
        .line-time { color: #aaa; font-size: 12px; font-family: monospace; margin-top: 2px; width: 38px; flex-shrink: 0; }
        .line-content { flex: 1; font-size: 15px; line-height: 1.4; }
        .text-target { font-size: 13px; color: #7f8c8d; margin-top: 4px; }

        #vocab-panel { padding: 10px; overflow-y: auto; }
        .vocab-item { border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #fff; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        
        /* === å½•éŸ³é¢æ¿æ ·å¼ === */
        #record-panel { padding: 15px; background: #fff; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .current-sentence-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; text-align: center; display: flex; flex-direction: column; gap: 12px; }
        .target-text { font-size: 16px; font-weight: bold; color: #2c3e50; min-height: 20px; }
        .record-controls { display: flex; gap: 20px; justify-content: center; align-items: center; }
        .circle-btn { width: 64px; height: 64px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 26px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .circle-btn:active { transform: scale(0.95); }
        .btn-play-origin { background: var(--accent); color: white; }
        .btn-record { background: white; border: 2px solid var(--record); color: var(--record); }
        .btn-record.recording { background: var(--record); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        
        .recordings-list { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .recording-item { display: flex; align-items: center; gap: 10px; background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .rec-name { font-size: 12px; color: #888; width: 40px; }
        audio { flex: 1; height: 32px; }
        .btn-del-rec { background: none; border: none; color: #ccc; font-size: 18px; padding: 5px; cursor: pointer; }
        .btn-del-rec:hover { color: #e74c3c; }

        /* FAB & Modal */
        #fab-add { position: absolute; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--accent); color: white; font-size: 30px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; z-index: 80; cursor: pointer; transition: transform 0.1s; }
        #fab-add:active { transform: scale(0.9); }
        .overlay-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 99; display: none; }
        #add-word-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; width: 85%; max-width: 320px; padding: 15px; border-radius: 12px; z-index: 100; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; margin-bottom: 10px; }
        
        @media (min-width: 769px) {
            main { flex-direction: row; }
            #video-section { height: 100%; flex: 1.6; }
            #right-panel { border-left: 1px solid #ccc; border-top: none; }
            #video-overlay { bottom: 60px; }
            .overlay-source { font-size: 24px; }
            .overlay-target { font-size: 16px; }
        }
    </style>
</head>
<body>

<header>
    <h4>å½±å­ v11.1</h4>
    <div class="group">
        <span class="group-label">ğŸŒ</span>
        <input type="text" id="urlInput" placeholder="MP4 é“¾æ¥">
        <button class="sm-btn" onclick="loadUrl()">Go</button>
        <button class="icon-btn" onclick="clearInput('url')">ğŸ—‘ï¸</button>
    </div>
    <div class="group">
        <span class="group-label">ğŸ“‚</span>
        <input type="file" id="fileVideo" accept="video/*" onchange="loadLocalVideo(this)">
        <button class="icon-btn" onclick="clearInput('video')">ğŸ—‘ï¸</button>
    </div>
    <div class="group">
        <span class="group-label">ğŸ“ å­¦ä¹ è¯­:</span>
        <input type="file" id="fileSub1" accept=".srt" onchange="loadSub(this, 'source')">
        <button class="icon-btn" onclick="clearInput('sub1')">ğŸ—‘ï¸</button>
    </div>
    <div class="group">
        <span class="group-label">ğŸ‡¨ğŸ‡³ æ¯è¯­:</span>
        <input type="file" id="fileSub2" accept=".srt" onchange="loadSub(this, 'target')">
        <button class="icon-btn" onclick="clearInput('sub2')">ğŸ—‘ï¸</button>
    </div>
</header>

<main>
    <div id="video-section">
        <video id="mainVideo" controls playsinline webkit-playsinline><p style="color:white">æµè§ˆå™¨ä¸æ”¯æŒ Video</p></video>
        <div id="play-overlay" onclick="triggerPlay()"><div class="big-play-btn">â–¶ï¸ ç‚¹å‡»æ’­æ”¾</div></div>
        <div id="video-status">å‡†å¤‡å°±ç»ª</div>
        <div id="video-overlay"><div class="overlay-source" id="overlay-s"></div><div class="overlay-target" id="overlay-t"></div></div>
        <div id="overlay-toggle"><button class="toggle-btn" id="overlayBtn" onclick="toggleOverlay()">å­—å¹•:å…³</button></div>
    </div>

    <div id="right-panel">
        <div class="tabs">
            <div class="tab active" id="tab-transcript" onclick="switchTab('transcript')">å­—å¹•åˆ—è¡¨</div>
            <div class="tab" id="tab-record" onclick="switchTab('record')">ğŸ™ï¸ å½•éŸ³</div>
            <div class="tab" id="tab-vocab" onclick="switchTab('vocab')">ç”Ÿè¯æœ¬ (<span id="vocab-count">0</span>)</div>
        </div>

        <!-- é¢æ¿1: å­—å¹• -->
        <div id="panel-transcript" class="panel-content active">
            <div id="controls-bar">
                <div class="ctrl-row">
                    <select id="displayMode" onchange="handleDisplayChange()" style="flex:1.5"><option value="both">åŒè¯­</option><option value="source">ä»…å­¦ä¹ è¯­</option><option value="target">ä»…æ¯è¯­</option></select>
                    <select id="speedSelect" onchange="changeSpeed()" style="flex:1">
                        <option value="0.5">0.5x</option>
                        <option value="0.8">0.8x</option>
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
						<option value="1.5">1.5x</option>
						<option value="2.0">2.0x</option>
                    </select>
                </div>
                <div class="ctrl-row">
                    <button class="act-btn" onclick="setLoopA()" id="btnLoopA">Aç‚¹</button>
                    <button class="act-btn" onclick="setLoopB()" id="btnLoopB">Bç‚¹</button>
                    <button class="act-btn" id="loopBtn" onclick="toggleSingleLoop()">å•å¥</button>
                </div>
                <div class="ctrl-row">
                    <button class="act-btn" onclick="nav(-1)">â¬† ä¸Šå¥</button>
                    <button class="act-btn" onclick="clearLoop()" id="btnClearLoop" style="display:none; background:#ffebee; color:#c62828;">å–æ¶ˆå¾ªç¯</button>
                    <button class="act-btn" onclick="nav(1)">â¬‡ ä¸‹å¥</button>
                </div>
            </div>
            <div id="transcript-list">
                <div style="padding:40px 20px; text-align:center; color:#999; font-size:13px;">è¯·åŠ è½½æ–‡ä»¶<br><span style="font-size:12px; color:#ccc;">æç¤º: åˆ’é€‰å•è¯åç‚¹å‡»å³ä¸‹è§’â•å·æ·»åŠ </span></div>
            </div>
            <button id="fab-add" onclick="manualAddWord()">â•</button>
        </div>

        <!-- é¢æ¿2: å½•éŸ³ -->
        <div id="panel-record" class="panel-content">
            <div id="record-panel">
                <div class="current-sentence-card">
                    <div class="target-text" id="rec-target-text">è¯·å…ˆåœ¨å­—å¹•åˆ—è¡¨é€‰æ‹©ä¸€å¥è¯</div>
                    
                    <div class="record-controls">
                        <button class="circle-btn btn-play-origin" onclick="playCurrentSentence()" title="å¬åŸéŸ³">ğŸ”Š</button>
                        <button class="circle-btn btn-record" id="btn-record-toggle" onclick="toggleRecording()" title="å½•éŸ³">ğŸ™ï¸</button>
                    </div>

                    <!-- å¯¼èˆªæ§åˆ¶ (æ–°å¢) -->
                    <div class="ctrl-row" style="width:100%;">
                        <button class="act-btn" onclick="nav(-1)">â¬† ä¸Šä¸€å¥</button>
                        <button class="act-btn" onclick="nav(1)">â¬‡ ä¸‹ä¸€å¥</button>
                    </div>
                </div>
                <div style="font-weight:bold; color:#555; margin-top:5px;">æˆ‘çš„å½•éŸ³:</div>
                <div class="recordings-list" id="recordings-list">
                    <div style="text-align:center; color:#ccc; font-size:13px; margin-top:20px;">æš‚æ— å½•éŸ³ï¼Œè¯•ç€å½•ä¸€å¥å§ï¼</div>
                </div>
            </div>
        </div>

        <!-- é¢æ¿3: ç”Ÿè¯æœ¬ -->
        <div id="panel-vocab" class="panel-content">
            <div id="vocab-panel">
                <div style="display:flex; gap:8px; margin-bottom:10px;">
                    <button class="act-btn" onclick="exportFile('txt')">TXT</button>
                    <button class="act-btn" onclick="exportFile('csv')">Excel</button>
                    <button class="act-btn" style="color:#e74c3c; border-color:#fadbd8; background:#fff5f5;" onclick="clearVocab()">æ¸…ç©º</button>
                </div>
                <div id="vocab-list-container"></div>
            </div>
        </div>
    </div>
</main>

<div class="overlay-mask" id="modalMask"></div>
<div id="add-word-modal">
    <h4 style="margin:0 0 10px 0; color:#333;">æ·»åŠ ç”Ÿè¯</h4>
    <div class="form-group"><input type="text" id="vocab-word" readonly style="background:#f5f5f5; font-weight:bold;"></div>
    <div class="form-group"><input type="text" id="vocab-def" placeholder="è¾“å…¥é‡Šä¹‰..." autocomplete="off"></div>
    <div class="form-group"><textarea id="vocab-eg" rows="3"></textarea></div>
    <div class="modal-actions" style="margin-top:10px; display:flex; justify-content:flex-end; gap:10px;">
        <button class="act-btn" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="act-btn active" onclick="saveVocab()">ä¿å­˜</button>
    </div>
</div>

<script>
    const state={subs:{source:[],target:[]},activeIndex:-1,loopMode:'none',loopA:null,loopB:null,overlayOn:false,manualSeek:false,vocab:[],
        mediaRecorder: null, audioChunks: [], isRecording: false, recordings: []
    };
    let lastSelectedText = "";

    function init(){
        try{const s=localStorage.getItem('shadow_vocab');if(s)state.vocab=JSON.parse(s);}catch(e){}
        updateVocabUI();
        document.addEventListener('selectionchange', () => { const sel = window.getSelection().toString().trim(); if(sel) lastSelectedText = sel; });
        document.addEventListener('copy', () => { setTimeout(() => { const text = window.getSelection().toString().trim() || lastSelectedText; if(text) popupVocabModal(text); }, 100); });
        window.addEventListener('beforeunload',(e)=>{e.preventDefault();e.returnValue='';});
    }
    
    // === å½•éŸ³æ ¸å¿ƒ ===
    function playCurrentSentence() {
        if(state.activeIndex === -1 || !state.subs.source[state.activeIndex]) { alert("è¯·å…ˆé€‰æ‹©ä¸€å¥è¯"); return; }
        const item = state.subs.source[state.activeIndex];
        video.currentTime = item.start; video.play();
        const stopTime = item.end;
        const checkTime = () => { if(video.currentTime >= stopTime) { video.pause(); video.removeEventListener('timeupdate', checkTime); } };
        video.addEventListener('timeupdate', checkTime);
    }

    async function toggleRecording() {
        if (!state.isRecording) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("éº¦å…‹é£æƒé™å—é™ (è¯·ä½¿ç”¨ HTTPS æˆ– localhost)"); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = event => state.audioChunks.push(event.data);
                state.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    addRecordingToList(audioUrl);
                };
                state.mediaRecorder.start();
                state.isRecording = true;
                updateRecordBtnUI();
            } catch (err) { alert("éº¦å…‹é£å¯åŠ¨å¤±è´¥: " + err.message); }
        } else {
            state.mediaRecorder.stop();
            state.isRecording = false;
            updateRecordBtnUI();
        }
    }

    function updateRecordBtnUI() {
        const btn = document.getElementById('btn-record-toggle');
        if(state.isRecording) { btn.classList.add('recording'); btn.innerText = "â¹"; } 
        else { btn.classList.remove('recording'); btn.innerText = "ğŸ™ï¸"; }
    }

    function addRecordingToList(url) {
        const list = document.getElementById('recordings-list');
        if(state.recordings.length === 0) list.innerHTML = '';
        state.recordings.push(url);
        const index = state.recordings.length;
        const item = document.createElement('div');
        item.className = 'recording-item';
        item.innerHTML = `<span class="rec-name">#${index}</span><audio controls src="${url}"></audio><button class="btn-del-rec" onclick="deleteRecording(this, '${url}')">Ã—</button>`;
        list.insertBefore(item, list.firstChild);
    }

    function deleteRecording(btn, url) { btn.parentElement.remove(); URL.revokeObjectURL(url); }

    // === UI åˆ‡æ¢ ===
    function switchTab(t){
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.panel-content').forEach(x=>x.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.getElementById('panel-'+t).classList.add('active');
        if(t === 'record') updateRecordText();
    }
    
    function updateRecordText() {
        const txtDiv = document.getElementById('rec-target-text');
        if(state.activeIndex !== -1 && state.subs.source[state.activeIndex]) {
            txtDiv.innerText = state.subs.source[state.activeIndex].text;
        } else {
            txtDiv.innerText = "è¯·å…ˆåœ¨å­—å¹•åˆ—è¡¨é€‰æ‹©ä¸€å¥è¯";
        }
    }

    // === åŸºç¡€æ’­æ”¾å™¨ ===
    const video=document.getElementById('mainVideo');
    const statusDiv=document.getElementById('video-status');
    const playOverlay=document.getElementById('play-overlay');
    const listDiv=document.getElementById('transcript-list');

    video.onerror=function(){showStatus("âŒ æ— æ³•æ’­æ”¾: æ ¼å¼ä¸æ”¯æŒ",5000);playOverlay.style.display='none';};
    video.onloadedmetadata=function(){showStatus("âœ… å°±ç»ª",3000);playOverlay.style.display='flex';};
    function showStatus(t,d){statusDiv.innerText=t;statusDiv.style.display='block';if(d)setTimeout(()=>statusDiv.style.display='none',d);}
    function triggerPlay(){video.play().then(()=>{playOverlay.style.display='none';}).catch(e=>{showStatus("æ’­æ”¾å¤±è´¥:"+e.message,3000);});}

    function loadUrl(){const v=document.getElementById('urlInput').value;if(v){video.src=v;}}
    function loadLocalVideo(i){const f=i.files[0];if(f)video.src=URL.createObjectURL(f);}
    function loadSub(i,t){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{state.subs[t]=parseSRT(e.target.result);renderList();};r.readAsText(f);}
    
    function handleDisplayChange(){renderList();if(state.activeIndex!==-1)updateOverlay(state.activeIndex);}
    function parseSRT(d){const i=[];const r=/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n\n|\n$|$)/g;d=d.replace(/\r\n/g,'\n');let m;while((m=r.exec(d))!==null){i.push({start:timeToSec(m[1]),end:timeToSec(m[2]),text:m[3].trim()});}return i;}
    function timeToSec(s){const p=s.split(':'),sec=p[2].split(',');return parseInt(p[0])*3600+parseInt(p[1])*60+parseInt(sec[0])+parseFloat(sec[1])/1000;}
    function fmtTime(s){const m=Math.floor(s/60).toString().padStart(2,'0'),sec=Math.floor(s%60).toString().padStart(2,'0');return `${m}:${sec}`;}
    function renderList(){const s=state.subs.source,t=state.subs.target,m=document.getElementById('displayMode').value;listDiv.innerHTML='';if(!s||!s.length){listDiv.innerHTML='<div style="padding:40px 20px; text-align:center; color:#999; font-size:13px;">è¯·å…ˆåŠ è½½å­—å¹•</div>';return;}s.forEach((it,i)=>{const mid=(it.start+it.end)/2,tt=t.find(x=>mid>=x.start&&mid<=x.end),txt=tt?tt.text:'',div=document.createElement('div');div.className='line';div.id=`line-${i}`;div.onclick=(e)=>{if(!window.getSelection().toString())jumpTo(i);};let h='';if(m==='source')h=`<div class="line-content">${it.text}</div>`;else if(m==='target')h=`<div class="line-content" style="color:#555">${txt||'(æ— )'}</div>`;else h=`<div class="line-content">${it.text}<div class="text-target">${txt}</div></div>`;div.innerHTML=`<span class="line-time">${fmtTime(it.start)}</span>${h}`;listDiv.appendChild(div);});}

    function jumpTo(i){if(!state.subs.source[i])return;state.activeIndex=i;state.manualSeek=true;video.currentTime=state.subs.source[i].start+0.01;video.play();highlightLine(i);updateOverlay(i);playOverlay.style.display='none'; setTimeout(()=>state.manualSeek=false,600); 
        updateRecordText(); // åŒæ­¥æ›´æ–°å½•éŸ³æ–‡å­—
    }
    function highlightLine(i){document.querySelectorAll('.line.active').forEach(x=>x.classList.remove('active'));const e=document.getElementById(`line-${i}`);if(e){e.classList.add('active');e.scrollIntoView({behavior:"smooth",block:"center"});}}
    function findIdx(){const t=video.currentTime;return state.subs.source.findIndex(i=>t>=i.start&&t<i.end);}
    function setLoopA(){const i=findIdx();state.loopA=(i!==-1)?state.subs.source[i].start:video.currentTime;state.loopMode='ab';updateLoopUI();}
    function setLoopB(){if(state.loopA===null)state.loopA=0;const i=findIdx();state.loopB=(i!==-1)?state.subs.source[i].end:video.currentTime;if(state.loopB<state.loopA){if(i!==-1){state.loopA=state.subs.source[i].start;state.loopB=state.subs.source[i].end;}else{[state.loopA,state.loopB]=[state.loopB,state.loopA];}}state.loopMode='ab';video.currentTime=state.loopA;video.play();updateLoopUI();}
    function clearLoop(){state.loopMode='none';state.loopA=null;state.loopB=null;updateLoopUI();}
    function toggleSingleLoop(){state.loopMode=state.loopMode==='single'?'none':'single';if(state.loopMode==='single'&&state.activeIndex===-1)syncIdx();updateLoopUI();}
    function updateLoopUI(){const a=document.getElementById('btnLoopA'),b=document.getElementById('btnLoopB'),c=document.getElementById('btnClearLoop'),s=document.getElementById('loopBtn');a.className='act-btn';b.className='act-btn';s.className='act-btn';c.style.display='none';if(state.loopMode==='ab'){if(state.loopA!==null)a.classList.add('loop-on');if(state.loopB!==null)b.classList.add('loop-on');c.style.display='inline-flex';}else if(state.loopMode==='single')s.classList.add('active');}

    function manualAddWord() { const text = window.getSelection().toString().trim() || lastSelectedText; if(!text) { alert("è¯·å…ˆåˆ’é€‰å•è¯ï¼"); return; } popupVocabModal(text); }
    function popupVocabModal(t){let c="";if(state.activeIndex!==-1){const s=state.subs.source,p=s[state.activeIndex-1]?.text||"",cr=s[state.activeIndex].text,n=s[state.activeIndex+1]?.text||"";c=`${p} ${cr} ${n}`.trim();}document.getElementById('vocab-word').value=t;document.getElementById('vocab-def').value="";document.getElementById('vocab-eg').value=c;document.getElementById('modalMask').style.display='block';document.getElementById('add-word-modal').style.display='block';}
    function closeModal(){document.getElementById('modalMask').style.display='none';document.getElementById('add-word-modal').style.display='none';}
    function saveVocab(){const w=document.getElementById('vocab-word').value,d=document.getElementById('vocab-def').value,e=document.getElementById('vocab-eg').value;if(!w)return;state.vocab.unshift({word:w,def:d,eg:e,date:new Date().toLocaleDateString()});localStorage.setItem('shadow_vocab',JSON.stringify(state.vocab));updateVocabUI();closeModal();if(state.overlayOn)updateOverlay(state.activeIndex);}
    function updateVocabUI(){document.getElementById('vocab-count').innerText=state.vocab.length;const c=document.getElementById('vocab-list-container');c.innerHTML='';state.vocab.forEach((v,i)=>{const d=document.createElement('div');d.className='vocab-item';d.innerHTML=`<div style="font-weight:bold;color:#333">${v.word}</div><div style="font-size:13px;color:#e67e22;margin:4px 0;">${v.def}</div><div style="font-size:12px;color:#888;background:#f9f9f9;padding:6px;border-radius:4px;">${v.eg}</div><button style="position:absolute;top:10px;right:10px;border:none;background:none;color:#e74c3c;font-size:16px;" onclick="delVocab(${i})">Ã—</button>`;c.appendChild(d);});}
    function delVocab(i){state.vocab.splice(i,1);localStorage.setItem('shadow_vocab',JSON.stringify(state.vocab));updateVocabUI();if(state.overlayOn)updateOverlay(state.activeIndex);}
    function clearVocab(){if(confirm('æ¸…ç©º?')){state.vocab=[];localStorage.setItem('shadow_vocab','[]');updateVocabUI();}}

    function toggleOverlay(){state.overlayOn=!state.overlayOn;document.getElementById('video-overlay').style.display=state.overlayOn?'block':'none';const b=document.getElementById('overlayBtn');b.innerText=state.overlayOn?"å…³":"å¼€";b.classList.toggle('active',state.overlayOn);if(state.overlayOn&&state.activeIndex!==-1)updateOverlay(state.activeIndex);}
    function updateOverlay(i){if(!state.overlayOn)return;const s=state.subs.source[i],m=document.getElementById('displayMode').value,os=document.getElementById('overlay-s'),ot=document.getElementById('overlay-t');os.innerHTML="";ot.innerText="";if(s){if(m==='source'||m==='both')os.innerHTML=highlightText(s.text);if(m==='target'||m==='both'){const mid=(s.start+s.end)/2,t=state.subs.target.find(x=>mid>=x.start&&mid<=x.end);if(t)ot.innerText=t.text;}}}
    function highlightText(t){if(!t)return"";let r=t;state.vocab.map(v=>v.word).sort((a,b)=>b.length-a.length).forEach(w=>{if(w)try{r=r.replace(new RegExp(`(${w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi'),'<span class="vocab-highlight">$1</span>');}catch(e){}});return r;}
    
    video.addEventListener('timeupdate',()=>{if(state.manualSeek)return;const t=video.currentTime,src=state.subs.source;if(!src||!src.length)return;if(state.loopMode==='ab'&&state.loopA!==null&&state.loopB!==null){if(t>=state.loopB){video.currentTime=state.loopA;video.play();return;}}if(state.loopMode==='single'&&state.activeIndex!==-1){if(t>src[state.activeIndex].end){video.currentTime=src[state.activeIndex].start;video.play();return;}}const idx=src.findIndex(i=>t>=i.start&&t<i.end);if(idx!==-1&&idx!==state.activeIndex){if(state.loopMode!=='single'){state.activeIndex=idx;highlightLine(idx);updateOverlay(idx);}}});
    function syncIdx(){const t=video.currentTime,i=state.subs.source.findIndex(s=>t>=s.start&&t<=s.end);if(i!==-1)state.activeIndex=i;}
    function changeSpeed(){video.playbackRate=parseFloat(document.getElementById('speedSelect').value);}
    function nav(d){const n=state.activeIndex+d;if(n>=0&&n<state.subs.source.length)jumpTo(n);}
    function exportFile(type) {
        if(!state.vocab.length){ alert("ç©º"); return; }
        let c="",mime="",ext="";
        if(type==='txt'){ext=".txt";mime="text/plain";c="å•è¯\té‡Šä¹‰\tè¯­å¢ƒ\n";state.vocab.forEach(v=>c+=`${v.word}\t${v.def}\t${v.eg}\n`);}
        else if(type==='csv'){ext=".csv";mime="text/csv";c="\ufeffå•è¯,é‡Šä¹‰,è¯­å¢ƒ\n";state.vocab.forEach(v=>c+=`"${v.word}","${v.def}","${v.eg}"\n`);}
        const blob=new Blob([c],{type:mime});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download="vocab"+ext;a.click();
    }

    init();
</script>
</body>
</html>